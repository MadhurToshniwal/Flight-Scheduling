
import streamlit as st
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots

st.set_page_config(
    page_title="AeroFlow AI - Flight Scheduling Optimizer",
    page_icon="‚úàÔ∏è",
    layout="wide"
)

# Title and description
st.title("‚úàÔ∏è AeroFlow AI - Intelligent Flight Scheduling System")
st.markdown("### Optimizing Airport Operations with Advanced AI")

# Sidebar for controls
st.sidebar.header("Control Panel")
selected_analysis = st.sidebar.selectbox(
    "Select Analysis Type",
    ["Overview", "Delay Prediction", "Schedule Optimization", "Cascading Impact", "NLP Query"]
)

# Load data (in production, this would connect to real data sources)
@st.cache_data
def load_data():
    # Initialize components
    collector = FlightDataCollector("BOM")
    df = collector.load_sample_data("Flight_Data.xlsx")
    df = collector.calculate_congestion_index(df)
    return df

df = load_data()

# Main content area
col1, col2, col3, col4 = st.columns(4)

with col1:
    st.metric("Total Flights", len(df), "‚Üë 12%")
    
with col2:
    avg_delay = df['delay_minutes'].mean()
    st.metric("Avg Delay", f"{avg_delay:.1f} min", "‚Üì 5%")
    
with col3:
    on_time = (df['delay_minutes'] <= 15).mean() * 100
    st.metric("On-Time Performance", f"{on_time:.1f}%", "‚Üë 3%")
    
with col4:
    st.metric("Peak Congestion", f"{df['congestion_index'].max():.2f}", "‚Üì 8%")

st.divider()

# Analysis sections
if selected_analysis == "Overview":
    col1, col2 = st.columns(2)
    
    with col1:
        # Hourly traffic distribution
        hourly_traffic = df.groupby('hour').size().reset_index(name='flights')
        fig1 = px.bar(hourly_traffic, x='hour', y='flights',
                     title="Hourly Flight Distribution",
                     labels={'hour': 'Hour of Day', 'flights': 'Number of Flights'})
        st.plotly_chart(fig1, use_container_width=True)
    
    with col2:
        # Delay distribution
        fig2 = px.histogram(df, x='delay_minutes', nbins=30,
                           title="Delay Distribution",
                           labels={'delay_minutes': 'Delay (minutes)', 'count': 'Frequency'})
        st.plotly_chart(fig2, use_container_width=True)
    
    # Heatmap of delays by hour and day
    pivot_delays = df.pivot_table(values='delay_minutes', 
                                  index='hour', 
                                  columns='day_of_week', 
                                  aggfunc='mean')
    
    fig3 = px.imshow(pivot_delays,
                    labels={'x': 'Day of Week', 'y': 'Hour', 'color': 'Avg Delay (min)'},
                    title="Delay Patterns: Hour vs Day of Week",
                    color_continuous_scale='RdYlGn_r')
    st.plotly_chart(fig3, use_container_width=True)

elif selected_analysis == "Delay Prediction":
    st.header("üîÆ Delay Prediction Model")
    
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.subheader("Input Parameters")
        hour = st.slider("Hour of Day", 0, 23, 12)
        day = st.selectbox("Day of Week", 
                          ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"])
        airline = st.selectbox("Airline", df['airline'].unique() if 'airline' in df.columns else ["Air India", "IndiGo", "Vistara"])
        
        if st.button("Predict Delay"):
            # Initialize predictor
            predictor = DelayPredictor()
            X, y = predictor.prepare_features(df)
            metrics = predictor.train(X, y)
            
            # Make prediction
            sample = pd.DataFrame({
                'hour': [hour],
                'day_of_week': [["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].index(day)],
                'month': [1],
                'is_weekend': [1 if day in ["Saturday", "Sunday"] else 0],
                'is_peak_hour': [1 if (7 <= hour <= 10) or (17 <= hour <= 21) else 0],
                'congestion_index': [df[df['hour'] == hour]['congestion_index'].mean()]
            })
            
            predicted_delay = predictor.predict(sample)[0]
            
            st.success(f"Predicted Delay: {predicted_delay:.1f} minutes")
            st.info(f"Model Accuracy (R¬≤): {metrics['test_r2']:.3f}")
    
    with col2:
        st.subheader("Model Performance")
        
        # Feature importance
        if 'predictor' in locals():
            importance_df = pd.DataFrame({
                'feature': list(metrics['feature_importance'].keys()),
                'importance': list(metrics['feature_importance'].values())
            }).sort_values('importance', ascending=False)
            
            fig = px.bar(importance_df, x='importance', y='feature',
                        orientation='h', title="Feature Importance")
            st.plotly_chart(fig, use_container_width=True)

elif selected_analysis == "Schedule Optimization":
    st.header("üß¨ Genetic Algorithm Schedule Optimizer")
    
    if st.button("Run Optimization"):
        with st.spinner("Optimizing schedule..."):
            optimizer = GeneticScheduleOptimizer(df)
            result = optimizer.optimize()
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.metric("Delay Reduction", 
                     f"{result['improvement']['delay_reduction_percent']:.1f}%",
                     f"-{result['improvement']['original_total_delay'] - result['improvement']['optimized_total_delay']:.0f} min")
        
        with col2:
            st.metric("Fitness Score", 
                     f"{result['best_fitness']:.4f}",
                     "Optimized")
        
        # Convergence plot
        fig = px.line(y=result['fitness_history'],
                     title="Optimization Convergence",
                     labels={'index': 'Generation', 'y': 'Fitness Score'})
        st.plotly_chart(fig, use_container_width=True)

elif selected_analysis == "Cascading Impact":
    st.header("üåä Cascading Delay Impact Analysis")
    
    analyzer = CascadingImpactAnalyzer(df)
    critical_flights = analyzer.identify_critical_flights(10)
    
    # Display critical flights
    st.subheader("Top 10 Critical Flights")
    st.dataframe(critical_flights[['flight_number', 'direct_delay', 
                                   'affected_flights', 'cascading_impact']])
    
    # Network visualization data
    network_data = analyzer.visualize_network()
    st.info(f"Network contains {len(network_data['nodes'])} flights with {len(network_data['edges'])} dependencies")

elif selected_analysis == "NLP Query":
    st.header("üí¨ Natural Language Query Interface")
    
    nlp_processor = NLPQueryProcessor(df, DelayPredictor())
    
    query = st.text_input("Ask a question about flight scheduling:",
                         placeholder="e.g., What's the best time to schedule a morning flight?")
    
    if query:
        response = nlp_processor.process_query(query)
        
        st.subheader(response['response'])
        
        # Display results based on intent
        if response['intent'] == 'best_time':
            best_hours = response['data']['best_hours']
            st.success(response['data']['recommendation'])
            st.bar_chart(best_hours)
            
        elif response['intent'] == 'delay_prediction':
            st.metric("Predicted Delay", response['data']['predicted_delay'])
            st.info(f"Confidence: {response['data']['confidence']}")
            
        else:
            for key, value in response['data'].items():
                if isinstance(value, list):
                    st.write(f"**{key}:**")
                    st.dataframe(value)
                else:
                    st.write(f"**{key}:** {value}")

# Footer
st.divider()
st.markdown("### üìä System Status")
col1, col2, col3 = st.columns(3)

with col1:
    st.info("‚úÖ All Systems Operational")
    
with col2:
    st.info("üîÑ Last Update: 2 min ago")
    
with col3:
    st.info("üì° Connected to Live Data")
